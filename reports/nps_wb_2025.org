#+options: html-link-use-abs-url:nil html-postamble:auto
#+options: html-preamble:t html-scripts:nil html-style:t
#+options: html5-fancy:nil tex:t
#+options: title:t toc:nil email:t date:t author:t
#+title: Yellowstone National Park whitebark pine planting water balance analysis
#+date: June 16, 2025
#+author: Stephen Huysman
#+email: shuysman@gmail.com
#+html_doctype: xhtml-strict
#+html_container: div
#+html_content_class: content
#+description:
#+keywords:
#+html_link_home:
#+html_link_up:
#+html_mathjax:
#+html_equation_reference_format: \eqref{%s}
#+html_head:
#+html_head_extra:
#+subtitle:
#+infojs_opt:
#+BIBLIOGRAPHY:/home/steve/OneDrive/org/library.bib
#+LATEX_HEADER: \usepackage[margin=.75in]{geometry}
#+LATEX_HEADER: \renewcommand{\topfraction}{.95}
#+LATEX_HEADER: \renewcommand{\bottomfraction}{.95}
#+LATEX_HEADER: \renewcommand{\textfraction}{.05}
#+LATEX_HEADER: \renewcommand{\floatpagefraction}{.75}
#+LATEX_HEADER: \setcounter{topnumber}{4}
#+LATEX_HEADER: \setcounter{bottomnumber}{4}
#+LATEX_HEADER: \setcounter{totalnumber}{4}

* Executive Summary

Broad-scale macroclimate (1 km) projections show the three planting sites selected in Yellowstone National Park  (Avalanche Peak, Cub Creek, and Chittenden) potentially transitioning to climates that are unlikely to be favorable for whitebark pine. However, despite end-of-century (2075--2099) projections that reveal the potential for extreme drought stress at all three locations, topoedaphic features that could potentially shelter planted tree seedlings from drought stress are identified as potential microrefugia based on modeled water balance at microclimate scales (1 m). Chittenden shows the most extreme projected drought stress across the planting site, while larger areas of milder climate are projected to persist in the Avalanche Peak and Cub Creek locations. An algorithm to select planting sites by maximizing projected Actual Evapotranspiration (a measure reflecting growing conditions favorable to plants) and minimizing projected Climatic Water Deficit (a measure of drought stress) across the three planting units selected the largest amount of planting area in Cub Creek, then Avalanche Peak, followed by Chittenden. Potential planting locations that seek to minimize drought stress under the most extreme climate projections while maintaining growing conditions favorable for plants include the upper elevations in the eastern section of Avalanche Peak and the northwest facing hillside in Cub Creek. The central depression in Chittenden shows the most favorable modeled water balance in the location; however, Chittenden shows higher drought stress under all projections relative to the other planting locations.

* Introduction

The suitability of planting sites in Yellowstone National Park that
were selected for planting and seeding of whitebark pine (WBP; /Pinus
albicaulis/ Engelm.) in 2025 is assessed using a water balance
model. First, the broad-scale macroclimatic suitability of the sites
is assessed using a 1 km water balance model
[cite:@tercekHistoricalChangesPlant2021] by comparing the historical
and projected water balance of the planting sites to the climate found
at other locations where whitebark pine is found across the contiguous
United States (CONUS). Then, a high-resolution 1 m water balance model
based on USGS LiDAR data is used to assess the suitability of planting
sites selected in Yellowstone National Park by accounting for the
influence of fine-scale topoedaphic features (slope, aspect, soil
water holding capacity) on microclimate. Such fine-scale topoedaphic
features have been shown to create significant variability in climates
revealed by modeled local water balance, variability which may not be
apparent when using coarser climate or terrain models
[cite:@dyerGISBasedWaterBalance2019]. These microclimates may allow
for the persistence of climatically sensitive species such as
whitebark pine, even when regional macroclimates are unfavorable,
through the creation of climatic microrefugia which are locally favorable climates
[cite:@dobrowskiClimaticBasisMicrorefugia2011].

Here, the biophysical environment of plants is characterized by Actual
Evapotranspiration (AET)---a measure of plant water use and favorable
growing conditions---and Climatic Water Deficit (CWD)---a measure of
drought stress. As indicators of plant water use (AET) and plant water
need (CWD), these two variables are more robust predictors of
vegetation distributions than other climate variables such as
temperature or precipitation and are well correlated with vegetation
distributions across local to continental spatial scales
[cite:@stephensonActualEvapotranspirationDeficit1998]. AET is directly
correlated with growth rates in WBP seedlings and selecting planting
sites with high AET can promote establishment
[cite:@laufenbergBiophysicalGradientsPerformance2020]. Although no
evidence of mortality caused by CWD has been observed in WBP, it is
likely that high summer CWD could be detrimental to WBP establishment.

#+begin_src R :session :exports none :cache yes :eval never-export
  library(terra)
  library(tidyverse)
  library(tidyterra)
  library(lubridate)
  library(glue)
  library(sf)
  library(gghighlight)
  library(ggpubr)
  library(maptiles)

  
  terraOptions(progress = 0)

  drought_year <- 1988
  hist_years <- 2004:2024
  end_years <- 2075:2099

  scenarios <- tribble(
    ~gcm, ~scenario, ~label,
    "gridmet", "historical", "historical",
    "gridmet", "historical", "drought-year",
    "MRI-CGCM3", "rcp85", "warm-wet",
    "MRI-CGCM3", "rcp45", "warm-dry",
    "HadGEM2-CC365", "rcp85", "hot-dry",
    "CanESM2", "rcp85", "hot-wet"
  )

  sites <- read_csv("../src/sites.csv")
  sites_list <- sites$site

  input_dir <- "../data/input/"
  data_dir <- "/media/steve/THREDDS/data/nps_wb_2025/"

  load_historical_mean <- function(filename) {
    # Load and calculate historical AET/CWD mean
    r <- rast(filename)

    r <- r %>%
      subset(year(time(.)) %in% hist_years) %>% ## Limit to end-century conditions
      mean() %>%
      clamp(lower = 0, values = FALSE) / 10 ## remove NAs and divide by
    ## ten (nps gridded wb is
    ## provided in units x 10)
    return(r)
  }


  load_gcm_mean <- function(filename) {
    # Load in one GCM/RCP projection and calculate end-of-century
    # (end_years) average annual AET/CWD
    r <- rast(filename)

    # Fix dates in r. CDO doesn't save them right in the annual_sums
    # script, or I'm not using CDO correctly. Either way, set a date for
    # each layer in the middle of the year for the years covered by the
    # projections, 2006–2099. The actual date ~shouldn't~ matter...
    time(r) <- seq(ymd("2006-07-02"), ymd("2099-07-02"), by = "1 year")
    
    r <- r %>%
      subset(year(time(.)) %in% end_years) %>% ## Limit to end-century conditions
      mean() %>%
      clamp(lower = 0, values = FALSE) / 10 ## remove NAs and divide by
    ## ten (nps gridded wb is
    ## provided in units x 10)
    return(r)
  }


  aet_sprc <- sprc()
  cwd_sprc <- sprc()

  for (s in sites_list) {
    message("Starting: ", s)

    aet_data <- rast()
    cwd_data <- rast()  

    for (i in 1:length(scenarios$scenario)) {
      scenario <- scenarios$scenario[i]
      gcm <- scenarios$gcm[i]
      label <- scenarios$label[i]

      message("Processing: ", scenario, ", ", gcm, ", ", label)
      
      if (scenario == "historical") {
        ### Historical scenarios, separate branches for historical norms and drought-year
        aet_file <- file.path(data_dir, s, "sums", "historical_gridmet_AET_annual_sum.nc")
        cwd_file <- file.path(data_dir, s, "sums", "historical_gridmet_Deficit_annual_sum.nc")

        if (label == "historical") {
          r_aet <- load_historical_mean(aet_file)
          r_cwd <- load_historical_mean(cwd_file)
        } else if (label == "drought-year") {
          r_aet <- rast(aet_file)
          r_cwd <- rast(cwd_file)

          r_aet <- subset(r_aet, year(time(r_aet)) == drought_year) / 10
          r_cwd <- subset(r_cwd, year(time(r_cwd)) == drought_year) / 10
        }     
      } else {
        ### Projections
        aet_file <- file.path(data_dir, s, "sums", glue("{gcm}_{scenario}_AET_annual_sum.nc"))
        cwd_file <- file.path(data_dir, s, "sums", glue("{gcm}_{scenario}_Deficit_annual_sum.nc"))

        r_aet <- load_gcm_mean(aet_file)
        r_cwd <- load_gcm_mean(cwd_file)
      }

      names(r_aet) <- glue("{label}")
      names(r_cwd) <- glue("{label}")

      add(aet_data) <- r_aet
      add(cwd_data) <- r_cwd
    }

    add(aet_sprc) <- aet_data
    add(cwd_sprc) <- cwd_data
  }

  ### Make sure this matches the order in sites_list
  site_polys <- c(
    terra::vect("../data/input/avalanche_peak/shapefile/Avalanche_Peak_Seeds_Shapefile/Potential_Planting_Locations.shp"),
    terra::vect("../data/input/cub_creek/shapefile/Cub_Creek_Seedlings_Shapefile/Potential_Planting_Locations.shp"),
    terra::vect("../data/input/chittenden/shapefile/Chittenden_Seedling_Shapefile/Potential_Planting_Locations.shp")
  )
  names(site_polys) <- c(
    "avalanche_peak",
    "cub_creek",
    "chittenden"
  )

  site_polys <- project(site_polys, crs(aet_sprc[1]))
#+end_src

#+RESULTS[205b1412ec785802be6bdede3ed19a140c744f64]:

* Planting site macroclimate

Planting suitability was evaluated at a macroclimate (1 km) scale to
compare these sites to other regions where WBP grows. Historical
(2000–2019) and ensemble end-of-century (2070–2099) RCP4.5 and RCP8.5
averages of annual AET and CWD were retrieved from the NPS 1 km
Gridded Water Balance Model [cite:@tercekRobustProjectionsConsequences2023;
@tercekHistoricalChangesPlant2021] for WBP monitoring points located
in the contiguous United States (CONUS) sourced from the white pine
blister rust monitoring dataset (Huysman /et al./, in prep). WBP
monitoring data located in Canada were excluded because they are not
covered by the 1 km NPS Gridded Water Balance Model. The data were
used to plot the current and projected climate of the planting sites
analyzed in this report and other known locations of whitebark pine in
a two-dimensional climate space characterized by the relationship
between AET and CWD.

Using CONUS-wide WBP data to define the species' bioclimatic niche,
macroclimate projections show all three planting units transitioning
to the edge or outside of the historical climate conditions observed
for WBP, particularly those within the Greater Yellowstone Ecosystem
(GYE) (Figure [[fig:macroclimate]]). Chittenden shows the most extreme projected climate at this
scale, with highest AET and CWD out of all three units by 2070--2099
for both RCP4.5 and RCP8.5 ensemble projections.

#+begin_src R :session :file img/macroclimate.png :results output graphics file :height 1080 :width 1400 :res 200 :exports results  :cache yes :eval never-export
  aet_summary_dir <- file.path("/media/steve/THREDDS/data/nps_gridded_wb/summary_layers/AET/")
  cwd_summary_dir <- file.path("/media/steve/THREDDS/data/nps_gridded_wb/summary_layers/Deficit/")

  aet <- rast(file.path(aet_summary_dir, "historical/V_1_5_annual_gridmet_historical_AET_2000_2019_annual_means_cropped_units_mm.tif"))
  names(aet) <- "AET"
  cwd <- rast(file.path(cwd_summary_dir, "historical/V_1_5_annual_gridmet_historical_Deficit_2000_2019_annual_means_cropped_units_mm.tif"))
  names(cwd) <- "CWD"
  aet_45 <- rast(file.path(aet_summary_dir, "rcp45/ensembles/ensemble_2070_2099_annual_rcp45_AET_units_mm.tif"))
  names(aet_45) <- "AET_45"
  cwd_45 <- rast(file.path(cwd_summary_dir, "rcp45/ensembles/ensemble_2070_2099_annual_rcp45_Deficit_units_mm.tif"))
  names(cwd_45) <- "CWD_45"
  aet_85 <- rast(file.path(aet_summary_dir, "rcp85/ensembles/ensemble_2070_2099_annual_rcp85_AET_units_mm.tif"))
  names(aet_85) <- "AET_85"
  cwd_85 <- rast(file.path(cwd_summary_dir, "rcp85/ensembles/ensemble_2070_2099_annual_rcp85_Deficit_units_mm.tif"))
  names(cwd_85) <- "CWD_85"

  wbp_points <- read_csv("/home/steve/OneDrive/whitebark/blister-rust/data/SITE_LOCATIONS.csv") %>%
    bind_rows(tibble(network = "YELL", park = "YELL", long = sites$lon, lat = sites$lat, site = sites$site)) %>%
    drop_na(c("lat", "long")) %>%
    st_as_sf(coords = c("long", "lat"), crs = st_crs("EPSG:4326")) %>%
    st_transform(crs = st_crs(aet))

  wbp_points <- terra::extract(aet, wbp_points, bind = TRUE)
  wbp_points <- terra::extract(cwd, wbp_points, bind = TRUE)
  wbp_points <- terra::extract(aet_45, wbp_points, bind = TRUE)
  wbp_points <- terra::extract(cwd_45, wbp_points, bind = TRUE)
  wbp_points <- terra::extract(aet_85, wbp_points, bind = TRUE)
  wbp_points <- terra::extract(cwd_85, wbp_points, bind = TRUE)

  ggplot(wbp_points) +
    geom_point(aes(x = CWD, y = AET), color = "darkgrey") +
    geom_point(data = filter(wbp_points, park == "GYE"), aes(x = CWD, y = AET), color = "royalblue1") +
      ## geom_point(aes(x = 179.89, 192.98), color = "blue", shape = 3, size = 10) +
      ## geom_text(aes(x = 179.89, 192.98), color = "blue", label = "historic") +
      ## geom_point(aes(x = 235.81, 247.61), color = "green", shape = 2, size = 10) +
      ## geom_text(aes(x = 235.81, 247.61), color = "green", label = "rcp4.5") +
      ## geom_point(aes(x = 306.32, 287.88), color = "red", shape = 2, size = 10) +
    ## geom_text(aes(x = 306.32, 287.88), color = "red", label = "rcp8.5") +
    geom_point(size = 6, data = filter(wbp_points, park == "YELL"), aes(x = CWD, y = AET, shape = site, color = "black")) +
    geom_point(size = 6, data = filter(wbp_points, park == "YELL"), aes(x = CWD_45, y = AET_45, shape = site, color = "orange")) +
    geom_point(size = 6, data = filter(wbp_points, park == "YELL"), aes(x = CWD_85, y = AET_85, shape = site, color = "red")) +
    scale_color_manual(name = "Scenario (color)",
                      values = c("black"="black",
                                 "orange"="orange",
                                 "red"="red"),
                      labels=c("Historical 2000–2019","RCP45 2070–2099 ","RCP85 2070–2099")) +
    #geom_text(data = filter(wbp_points, park == "YELL"), aes(x = CWD, y = AET, label = site), nudge_y = -10) +
    #geom_text(data = filter(wbp_points, park == "YELL"), aes(x = CWD, y = AET), label = "Historical", nudge_y = -10, size = 5) +
    #geom_text(data = filter(wbp_points, park == "YELL"), aes(x = CWD_45, y = AET_45), label = "4.5", nudge_y = -10, size = 5) +
    #geom_text(data = filter(wbp_points, park == "YELL"), aes(x = CWD_85, y = AET_85), label = "8.5", nudge_y = -10, size = 5) +
    labs(x = "Annual CWD (mm)", y = "Annual AET (mm)", shape = "Site (shape)")
    #labs(title = "WBP Bioclimatic Niche (GYE)")
#+end_src

#+CAPTION: Macroclimate space of YELL whitebark pine at 1 km scale. Whitebark pine observations in CONUS from the white pine blister rust monitoring dataset (Huysman /et al./, in prep) were used to create a bioclimatic niche of the species from historical (2000–2019) average annual AET and CWD from the NPS 1 km gridded water balance model [cite:@tercekHistoricalChangesPlant2021]. Historical 2000–2019 average annual AET and CWD for points located in the Greater Yellowstone Ecosystem are highlighted in blue and all other WBP locations in the monitoring dataset across CONUS are grey. The three planting units in Yellowstone National Park analyzed in this report are shown as circles (Avalanche Peak), triangles (Chittenden), and squares (Cub Creek). Historical 2000--2019 water balance for these planting sites are shown in black and projected 2070--2099 water balance for the three planting units are shown in orange (RCP4.5) and red (RCP8.5).
#+LABEL: fig:macroclimate
#+RESULTS[afa331d39bd034a49e999da38a20dabf13a007d4]:
[[file:img/macroclimate.png]]

* Planting site microclimate

Figures [[fig:microclimate-aet]] and [[fig:microclimate-cwd]] show the microclimatic variability in average annual AET and CWD for historical and projected climate scenarios for the three planting units. The 1988 drought-year, where record low precipitation resulted in widespread drought and wildfire across the Greater Yellowstone Ecosystem [cite:@christensenInterpretingYellowstoneFires1989], shows much lower annual AET and much higher CWD for all three planting units compared to the 2004-2024 historical baseline average annual values.

Four projected climate scenarios (combinations of General Circulation models [GCM] and Representative Concentration Pathways [RCP]) were chosen to bracket extremes of changes in annual temperature and precipitation in Yellowstone National Park [cite:@lawrenceDivergentPlausibleRelevant2021]: /warm-wet/ (MRI-CGCM3/RCP8.5), /warm-dry/ (MRI-CGCM3/RCP4.5), /hot-dry/ (HadGEM2-CC365/RCP8.5), and /hot-wet/ (CanESM2/RCP8.5). All of these projections show increases in average annual AET and CWD compared to the 2004-2024 historical baseline. Three of the four projected scenarios show average annual CWD that are similar or greater in magnitude to the annual CWD experienced during 1988. These projections show that AET is not likely to be limiting at these sites but there is potential for extreme drought stress at all sites. Chittenden shows the highest potential for drought stress, with the highest projected CWD under the /hot-dry/ scenario.

Given this potential for drought stress at all planting units, the scenario with the highest projected CWD, /hot-dry/, will be used to represent the "worst-case" climate scenario, while /warm-dry/ will represent the "best-case" climate scenario because it shows the lowest increases in projected CWD.

#+begin_src R :session :file img/microclimate-aet.png :results output graphics file :height 900 :width 1200 :res 200 :exports results  :cache yes :eval never-export
  aet_data <- list()

  for (i in 1:length(sites$site)) {
    site <- sites$site[i]
    
    aet_df <- aet_sprc[i] %>%
      mask(site_polys[i]) %>%
      as.data.frame(wide = FALSE)

    aet_df$site <- site
    
    aet_data[[i]] <- aet_df
  }

  aet_data <- bind_rows(aet_data) %>%
    mutate(layer = factor(layer, levels = c("historical", "drought-year", "warm-wet", "warm-dry", "hot-dry", "hot-wet"))) %>%
    mutate(time = if_else(layer == "historical" | layer == "drought-year",
                          "historical",
                          "projection"))


  ggplot(aet_data) +
    geom_boxplot(aes(x = layer, y = values, color = site)) +
    labs(color = "Site", x = "Scenario", y = "Average annual AET (mm)") +
    theme(legend.position = "bottom", axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
    facet_wrap(~time, scales = "free_x") %>% print()
#+end_src

#+CAPTION: Microclimatic variability in annual AET across historical and projected climate scenarios. Modeled 1 m AET for two historical scenarios is shown: /historical/ 2004-2024 historical average and /drought-year/ 1988 annual AET. The average 2075-2099 average annual AET for four projections bracketing extremes of changes in annual temperature and precipitation are shown: /warm-wet/ (MRI-CGCM3/RCP8.5), /warm-dry/ (MRI-CGCM3/RCP4.5), /hot-dry/ (HadGEM2-CC365/RCP8.5), and /hot-wet/ (CanESM2/RCP8.5).
#+LABEL: fig:microclimate-aet
#+RESULTS[091ddecce598199e98512e0c135a07c5635b1e75]:
[[file:img/microclimate-aet.png]]

#+begin_src R :session :file img/microclimate-cwd.png :results output graphics file :height 900 :width 1200 :res 200 :exports results  :cache yes :eval never-export
  cwd_data <- list()

  for (i in 1:length(sites$site)) {
    site <- sites$site[i]
    
    cwd_df <- cwd_sprc[i] %>%
      mask(site_polys[i]) %>%
      as.data.frame(wide = FALSE)

    cwd_df$site <- site
    
    cwd_data[[i]] <- cwd_df
  }

  cwd_data <- bind_rows(cwd_data) %>%
    mutate(layer = factor(layer, levels = c("historical", "drought-year", "warm-wet", "warm-dry", "hot-dry", "hot-wet"))) %>%
    mutate(time = if_else(layer == "historical" | layer == "drought-year",
                          "historical",
                          "projection"))


  ggplot(cwd_data) +
    geom_boxplot(aes(x = layer, y = values, color = site)) +
    labs(color = "Site", x = "Scenario", y = "Average annual CWD (mm)") +
    theme(legend.position = "bottom", axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
    facet_wrap(~time, scales = "free_x")
#+end_src

#+CAPTION: Microclimatic variability in annual Climatic Water Deficit (CWD) across historical and projected climate scenarios. Modeled 1 m CWD for two historical scenarios is shown: /historical/ 2004-2024 historical average and /drought-year/ 1988 annual CWD. The average 2075-2099 average annual CWD for four projections bracketing extremes of changes in annual temperature and precipitation are shown: /warm-wet/ (MRI-CGCM3/RCP8.5), /warm-dry/ (MRI-CGCM3/RCP4.5), /hot-dry/ (HadGEM2-CC365/RCP8.5), and /hot-wet/ (CanESM2/RCP8.5).
#+LABEL: fig:microclimate-cwd
#+RESULTS[672f76e12b97b464e509276a71176f745b345ab1]:
[[file:img/microclimate-cwd.png]]

* Modeled 1 m water balance at planting sites

Modeled 1 m water balance for these planting sites shows significant variability in microclimates created by local terrain features. Figures [[fig:wb-avalanche]], [[fig:wb-cub_creek]], and [[fig:wb-chittenden]] show the modeled 1 m water balance for historical and projected climate scenarios for Avalanche Peak, Cub Creek, and Chittenden, respectively. Spatial patterns of AET and CWD are consistent across time periods: more northern exposures and higher soil water holding capacities maximize AET and minimize CWD and more southern exposures and lower soil water holding capacities minimize AET and maximize CWD.

#+begin_src R :session :exports none  :cache yes :eval never-export
  ## Find global max AET and CWD for color scaling
  max_aet <- 0
  for (i in 1:length(sites$site)) {
    unit_data <- mask(aet_sprc[i], site_polys[i])

    new_max_aet <- max(minmax(unit_data))
    if (new_max_aet > max_aet) {
      max_aet <- new_max_aet
    }
  }

  max_cwd <- 0
  for (i in 1:length(sites$site)) {
    unit_data <- mask(cwd_sprc[i], site_polys[i])

    new_max_cwd <- max(minmax(unit_data))
    if (new_max_cwd > max_cwd) {
      max_cwd <- new_max_cwd
    }
  }

  aet_scale <-
    scale_fill_viridis_c(option = "D", limits = c(0, max_aet))

  cwd_scale <-
      scale_fill_viridis_c(option = "B", limits = c(0, max_cwd))

#+end_src

#+RESULTS[a498f8744220861487e762cbd3ef91069a560d6a]:

#+begin_src R :session :file img/wb-avalanche.png :results output graphics file :height 1200 :width 2000 :res 175 :exports results  :cache yes :eval never-export
avalanche_id <- 1

site <- sites$site[avalanche_id]

aet_data <- mask(aet_sprc[avalanche_id], site_polys[avalanche_id])

avalanche_aet_plot <- ggplot() +
  geom_spatraster(data = aet_data) +
  aet_scale + 
  facet_wrap(~lyr, ncol = 2) +
  labs(title = "Avalanche Peak average annual AET", fill = "Annual AET (mm)") +
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

cwd_data <- mask(cwd_sprc[avalanche_id], site_polys[avalanche_id])
    
avalanche_cwd_plot <- ggplot() +
  geom_spatraster(data = cwd_data) +
  cwd_scale + 
  facet_wrap(~lyr, ncol = 2) +
  labs(title = "Avalanche Peak average annual CWD", fill = "Annual CWD (mm)") +
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggarrange(avalanche_aet_plot, avalanche_cwd_plot, ncol = 2)
#+end_src

#+CAPTION: Modeled historical and projected average annual AET and CWD for Avalanche Peak. The color ramps used for AET and CWD visualizations are kept the same between planting units and climate scenarios to facilitate direct comparisons between units or time periods. 
#+LABEL: fig:wb-avalanche
#+RESULTS[5116df37516fba97ab503b2c79e0d58ef37ecebf]:
[[file:img/wb-avalanche.png]]

#+begin_src R :session :file img/wb-cub_creek.png :results output graphics file :height 1200 :width 1900 :res 175 :exports  results  :cache yes :eval never-export
cub_creek_id <- 2

site <- sites$site[cub_creek_id]

aet_data <- mask(aet_sprc[cub_creek_id], site_polys[cub_creek_id])

cub_creek_aet_plot <- ggplot() +
  geom_spatraster(data = aet_data) +
  aet_scale + 
  facet_wrap(~lyr, ncol = 2) +
  labs(title = "Cub Creek average annual AET", fill = "Annual AET (mm)") +
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

cwd_data <- mask(cwd_sprc[cub_creek_id], site_polys[cub_creek_id])
    
cub_creek_cwd_plot <- ggplot() +
  geom_spatraster(data = cwd_data) +
  cwd_scale + 
  facet_wrap(~lyr, ncol = 2) +
  labs(title = "Cub Creek average annual CWD", fill = "Annual CWD (mm)") +
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggarrange(cub_creek_aet_plot, cub_creek_cwd_plot, ncol = 2)
#+end_src

#+CAPTION: Modeled historical and projected average annual AET and CWD for Cub Creek. The color ramps used for AET and CWD visualizations are kept the same between planting units and climate scenarios to facilitate direct comparisons between units or time periods. 
#+LABEL: fig:wb-cub_creek
#+RESULTS[b90931d91c0b0b89d564a21babc0a0eb0b80c715]:
[[file:img/wb-cub_creek.png]]

#+begin_src R :session :file img/wb-chittenden.png :results output graphics file :height 1800 :width 1600 :res 175 :exports results  :cache yes :eval never-export
chittenden_id <- 3

site <- sites$site[chittenden_id]

aet_data <- mask(aet_sprc[chittenden_id], site_polys[chittenden_id])

chittenden_aet_plot <- ggplot() +
  geom_spatraster(data = aet_data) +
  aet_scale + 
  facet_wrap(~lyr, ncol = 2) +
  labs(title = "Chittenden average annual AET", fill = "Annual AET (mm)") +
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

cwd_data <- mask(cwd_sprc[chittenden_id], site_polys[chittenden_id])
    
chittenden_cwd_plot <- ggplot() +
  geom_spatraster(data = cwd_data) +
  cwd_scale + 
  facet_wrap(~lyr, ncol = 2) +
  labs(title = "Chittenden average annual CWD", fill = "Annual CWD (mm)") +
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggarrange(chittenden_aet_plot, chittenden_cwd_plot, ncol = 2)
#+end_src

#+CAPTION: Modeled historical and projected average annual AET and CWD for Chittenden. The color ramps used for AET and CWD visualizations are kept the same between planting units and climate scenarios to facilitate direct comparisons between units or time periods. 
#+LABEL: fig:wb-chittenden
#+RESULTS[e9b07bc566edb247f457e275e83560b8982b7f67]:
[[file:img/wb-chittenden.png]]

* Planting site selection

Algorithmically selected planting locations that maximize AET and
minimize CWD in end-of-century (2075--2099) projections are shown for
the worst-case (hot-dry) (Figure [[fig:planting-map-worst]]) and best-case
(warm-dry) (Figure [[fig:planting-map-best]]) climate scenarios. The
worst-case planting sites are conservative recommendations, that seek
to minimize drought stress under the projection with highest CWD
values (Figure [[fig:microclimate-cwd]]). For the worst-case scenario, no
planting locations are recommended by the algorithm in the Chittenden
location because of its high projected CWD. Under the best-case
climate scenario, minimizing drought stress is less critical because
the projected drought stress is similar in magnitude to current
conditions. However, the planting recommendations under the best-case
scenario still seek to optimize conditions of water availability and
drought stress.

The planting site recommendation algorithm works by selecting the
1,000,000 cells with highest AET and 1,000,000 cells with lowest CWD,
then taking the union of those locations. Because there are locations
with high AET that do not have low CWD, and vice-versa, the final area
identified is smaller than the initial 1,000,000 cells. For the
worst-case scenario, the final identified area is approximately 0.18
km^2 and for the best-case scenario is approximately 0.1 km^2. The
area selected in the best-case scenario is smaller because there is
less overlap between pixels with high AET and low CWD in this
scenario. This algorithm can be tweaked by increasing or decreasing
the amount of cells to maximize AET/minimize CWD based on planting
objectives and management risk objectives. For example, if more seed
stock is available, the search area can be increased to find more
suitable planting locations, at the cost of less optimal AET and CWD
for some locations in the final union.

The planting sites selected by this algorithm are recommendations but
should not be taken as absolute prescriptions. Planting decisions made
using this data should consider observed soil characteristics in the
field in conjunction with data presented here. This work examines the
variability of microclimates within relatively coarse climate grid
cells due to sub-grid cell topograhic and edaphic features. These
methods likely present a more accurate representation of climate at
fine scales relevant to tree planting compared with unmodified use of
gridded climate data products. However, several caveats and
limitations exist with the use of these methods.

Climate data from a single gridMET/MACA grid cell were used to
represent each planting site analyzed in this report. These products are designed
to show broad-scale patterns at regional scales that hold across large
groups of pixels [cite:@abatzoglouDevelopmentGriddedSurface2013].
Uncertainty increases when these climate data products are applied to
sub-grid cell scale locations such as point-scale data or the
relatively small area examined here.

Temperature and precipitation data are not available at high
resolutions in this study system and all available gridded climate
data products have uncertainty in areas of complex topography such as
mountainous regions [cite:@behnkeEvaluationDownscaledGridded2016]. The
model and its climate inputs do not consider some sub-grid cell
phenomena affecting air temperature such as temperature inversions and
cold air drainage. Precipitation also varies at sub-grid cell scales
due to topographic effects such as orographic precipitation
[cite:@linCommonIngredientsHeavy2001]. Snow accumulation and melt were
modeled at the scale of the entire site, and not downscaled based on
topography. In reality, snow accumulation and melt is affected by
factors such as slope, aspect, as well as horizontal movement through
snow drift [cite:@dingmanPhysicalHydrology2015].,

The strength of this approach lies in its ability to detect relative
differences in wetness and dryness across a landscape in a way that
directly reflects the growing environment of plants. These relative
patterns in the water balance across the landscape come with a higher
degree of certainty than absolute estimates of AET and CWD. The model
can help identify microclimates in locations where ideal combinations
of soil and topography exist relative to other positions on the
landscape. These locations may be difficult to identify visually, even
for trained and experienced observers. For example, two hillslopes may
have similar slope and aspect but different soil water holding
capacities that lead to drier conditions on one than the other. In
addition, planters may be skillful at identifying suitable planting
sites based on current climatic conditions, but the methodology can
quantify the potential change in a landscape position under plausible
future climates relative to current conditions. The model reveals the
potential for extreme drought stress in some landscape positions based
on future climates, relative to current and past climatic conditions
at the site. Therefore, planting site selection based on current
conditions alone is unlikely to result in plantings that avoid this
stress in the future.

#+begin_src R :session :exports none   :cache yes :eval never-export
  n_cells <- 1000000

  hot_dry_cwd_sprc <- sprc()

  for (i in 1:length(sites_list)) {
    r <- cwd_sprc[i] %>% subset(5) %>% mask(site_polys[i])

    add(hot_dry_cwd_sprc) <- r
  }

  hot_dry_cwd <- merge(hot_dry_cwd_sprc)

  lowest_cwd <- selectHighest(hot_dry_cwd, n = n_cells, low = TRUE)

  hot_dry_aet_sprc <- sprc()

  for (i in 1:length(sites_list)) {
    r <- aet_sprc[i] %>% subset(5) %>% mask(site_polys[i])

    add(hot_dry_aet_sprc) <- r
  }

  hot_dry_aet <- merge(hot_dry_aet_sprc)

  highest_aet <- selectHighest(hot_dry_aet, n = n_cells, low = FALSE)

  ##plet(lowest_cwd)


  union_worst <- lowest_cwd & highest_aet

  ##plet(union)

  ##union_poly <- as.polygons(union)

  ## zonal(hot_dry_cwd, union_poly, fun = "mean")
  ## zonal(hot_dry_aet, union_poly, fun = "mean")

  ## zonal(hot_dry_cwd, union_poly, fun = "min")
  ## zonal(hot_dry_aet, union_poly, fun = "min")

  ## zonal(hot_dry_cwd, union_poly, fun = "max")
  ## zonal(hot_dry_aet, union_poly, fun = "max")
#+end_src

#+RESULTS[771cd3450ee1ef76d8dc70ea4294e061208d3b44]:

#+NAME: attr_wrap
#+BEGIN_SRC sh :var data="" :var height="\\textheight" :results output :exports none :eval never-export
  echo "#+ATTR_LATEX: :height $height"
  echo "$data"
#+END_SRC

#+RESULTS: attr_wrap
: #+ATTR_LATEX: :height 	extheight
: 

#+begin_src R :session :file img/worst-case-planting-map.png :results output graphics file :height 1800 :width 1080 :res 200 :exports results  :cache yes :post attr_wrap(height=".85\\textheight", data=*this*) :eval never-export
  avalanche_id <- 1
  cub_creek_id <- 2
  chittenden_id <- 3

  avalanche_best_sites <- terra::crop(union_worst, site_polys[avalanche_id])
  cub_creek_best_sites <- terra::crop(union_worst, site_polys[cub_creek_id]) 
  chittenden_best_sites <- terra::crop(union_worst, site_polys[chittenden_id])

  ### Stupid hack because problems with continuous/discrete scales...
  levels(avalanche_best_sites) <- c(FALSE, TRUE)
  levels(cub_creek_best_sites) <- c(FALSE, TRUE)
  levels(chittenden_best_sites) <- c(FALSE, TRUE)

  map_zoom <- 18

  base_map_avalanche <- get_tiles(site_polys[avalanche_id], provider = "Esri.WorldImagery", crop = TRUE, zoom = map_zoom)

  avalanche_planting_map <- ggplot() +
    geom_spatraster_rgb(data = base_map_avalanche, interpolate = TRUE, maxcell = Inf) +
    geom_spatraster(data = avalanche_best_sites) +
    scale_fill_discrete(na.value = "transparent") +
    geom_sf(data = site_polys[avalanche_id], fill = NA, lwd = 1.5, color = "lightblue") +
    labs(title = "Avalanche Peak", fill = "Selected Planting Locations") +
    scale_x_continuous(labels = function(x) paste0(x)) +
    scale_y_continuous(labels = function(x) paste0(x))

  base_map_cub_creek <- get_tiles(site_polys[cub_creek_id], provider = "Esri.WorldImagery", crop = TRUE, zoom = map_zoom)

  cub_creek_planting_map <- ggplot() +
    geom_spatraster_rgb(data = base_map_cub_creek, interpolate = TRUE, maxcell = Inf) +
    geom_spatraster(data = cub_creek_best_sites) +
    scale_fill_discrete(na.value = "transparent") +
    geom_sf(data = site_polys[cub_creek_id], fill = NA, lwd = 1.5, color = "lightblue") +
    labs(title = "Cub Creek", fill = "Selected Planting Locations") +
    scale_x_continuous(labels = function(x) paste0(x)) +
    scale_y_continuous(labels = function(x) paste0(x))

  base_map_chittenden <- get_tiles(site_polys[chittenden_id], provider = "Esri.WorldImagery", crop = TRUE, zoom = map_zoom)

  chittenden_planting_map <- ggplot() +
    geom_spatraster_rgb(data = base_map_chittenden, interpolate = TRUE, maxcell = Inf) +
    geom_spatraster(data = chittenden_best_sites) +
    scale_fill_discrete(na.value = "transparent") +
    geom_sf(data = site_polys[chittenden_id], fill = NA, lwd = 1.5, color = "lightblue") +
    labs(title = "Chittenden", fill = "Selected Planting Locations") +
    scale_x_continuous(labels = function(x) paste0(x)) +
    scale_y_continuous(labels = function(x) paste0(x))

  ggarrange(avalanche_planting_map, cub_creek_planting_map, chittenden_planting_map, ncol = 1, legend = "none")
#+end_src

#+CAPTION: Algorithmically selected planting locations (highlighted in pink) for the /hot-dry/ (worst-case) climate scenario. These are conservative planting location recommendations that seek to provide shelter from the most extreme projected drought conditions while maintaining conditions promoting plant growth. The final selected area is approximately 0.18 km^2. Note that no locations in Chittenden were idenified in this scenario. Tiles © Esri - Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community.
#+LABEL: fig:planting-map-worst
#+RESULTS[32011f4b81bee61307771d3ff7905623bd096602]:
#+ATTR_LATEX: :height .85\textheight :placement [p]
[[file:img/worst-case-planting-map.png]]

#+begin_src R :session :exports none  :cache yes :eval never-export
  n_cells <- 1000000

  warm_dry_cwd_sprc <- sprc()

  for (i in 1:length(sites_list)) {
    r <- cwd_sprc[i] %>% subset(4) %>% mask(site_polys[i])

    add(warm_dry_cwd_sprc) <- r
  }

  warm_dry_cwd <- merge(warm_dry_cwd_sprc)

  lowest_cwd <- selectHighest(warm_dry_cwd, n = n_cells, low = TRUE)

  warm_dry_aet_sprc <- sprc()

  for (i in 1:length(sites_list)) {
    r <- aet_sprc[i] %>% subset(4) %>% mask(site_polys[i])

    add(warm_dry_aet_sprc) <- r
  }

  warm_dry_aet <- merge(warm_dry_aet_sprc)

  highest_aet <- selectHighest(warm_dry_aet, n = n_cells, low = FALSE)

  ##plet(lowest_cwd)


  union_best <- lowest_cwd & highest_aet

  ##plet(union)

  ## zonal(warm_dry_cwd, union_poly, fun = "mean")
  ## zonal(warm_dry_aet, union_poly, fun = "mean")

  ## zonal(warm_dry_cwd, union_poly, fun = "min")
  ## zonal(warm_dry_aet, union_poly, fun = "min")

  ## zonal(warm_dry_cwd, union_poly, fun = "max")
  ## zonal(warm_dry_aet, union_poly, fun = "max")
#+end_src

#+RESULTS:
: 1

#+begin_src R :session :file img/best-case-planting-map.png :results output graphics file :height 1800 :width 1080 :res 200 :exports results  :cache yes :post attr_wrap(height=".85\\textheight", data=*this*) :eval never-export
  avalanche_id <- 1
  cub_creek_id <- 2
  chittenden_id <- 3

  avalanche_best_sites <- terra::crop(union_best, site_polys[avalanche_id])
  cub_creek_best_sites <- terra::crop(union_best, site_polys[cub_creek_id]) 
  chittenden_best_sites <- terra::crop(union_best, site_polys[chittenden_id])

  ### Stupid hack because problems with continuous/discrete scales...
  levels(avalanche_best_sites) <- c(FALSE, TRUE)
  levels(cub_creek_best_sites) <- c(FALSE, TRUE)
  levels(chittenden_best_sites) <- c(FALSE, TRUE)

  #map_zoom <- 18

  #base_map_avalanche <- get_tiles(site_polys[avalanche_id], provider = "Esri.WorldImagery", crop = TRUE, zoom = map_zoom)

  avalanche_planting_map <- ggplot() +
    geom_spatraster_rgb(data = base_map_avalanche, interpolate = TRUE, maxcell = Inf) +
    geom_spatraster(data = avalanche_best_sites) +
    scale_fill_discrete(na.value = "transparent") +
    geom_sf(data = site_polys[avalanche_id], fill = NA, lwd = 1.5, color = "lightblue") +
    labs(title = "Avalanche Peak", fill = "Selected Planting Locations") +
    scale_x_continuous(labels = function(x) paste0(x)) +
    scale_y_continuous(labels = function(x) paste0(x))

  #base_map_cub_creek <- get_tiles(site_polys[cub_creek_id], provider = "Esri.WorldImagery", crop = TRUE, zoom = map_zoom)

  cub_creek_planting_map <- ggplot() +
    geom_spatraster_rgb(data = base_map_cub_creek, interpolate = TRUE, maxcell = Inf) +
    geom_spatraster(data = cub_creek_best_sites) +
    scale_fill_discrete(na.value = "transparent") +
    geom_sf(data = site_polys[cub_creek_id], fill = NA, lwd = 1.5, color = "lightblue") +
    labs(title = "Cub Creek", fill = "Selected Planting Locations") +
    scale_x_continuous(labels = function(x) paste0(x)) +
    scale_y_continuous(labels = function(x) paste0(x))

  #base_map_chittenden <- get_tiles(site_polys[chittenden_id], provider = "Esri.WorldImagery", crop = TRUE, zoom = map_zoom)

  chittenden_planting_map <- ggplot() +
    geom_spatraster_rgb(data = base_map_chittenden, interpolate = TRUE, maxcell = Inf) +
    geom_spatraster(data = chittenden_best_sites) +
    scale_fill_discrete(na.value = "transparent") +
    geom_sf(data = site_polys[chittenden_id], fill = NA, lwd = 1.5, color = "lightblue") +
    labs(title = "Chittenden", fill = "Selected Planting Locations") +
    scale_x_continuous(labels = function(x) paste0(x)) +
    scale_y_continuous(labels = function(x) paste0(x))

  ggarrange(avalanche_planting_map, cub_creek_planting_map, chittenden_planting_map, ncol = 1, legend = "none")
#+end_src

#+CAPTION: Algorithmically selected planting locations (highlighted in pink) for the /warm-dry/ (best-case) climate scenario. There is only a slight increase in average CWD (drought stress) projected in this scenario, so avoidance of drought stress is less critical. These recommendations seek to optimize the balance of drought stress and water availability to promote plant growth and survival. The final selected area is approximately 0.1 km^2. Tiles © Esri - Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community.
#+LABEL: fig:planting-map-best
#+RESULTS[8f074a517daa9e6b5c6659a239abf5f12423cbbb]:
#+ATTR_LATEX: :height .85\textheight :placement [p]
[[file:img/best-case-planting-map.png]]

\clearpage

* Acknowledgments

Funding for this work was provided by the Northern Rockies Conservation Cooperative.

Computational efforts were performed on the Tempest High Performance Computing System, operated and supported by University Information Technology Research Cyberinfrastructure (RRID:SCR\_026229) at Montana State University.

* References Cited 
#+PRINT_BIBLIOGRAPHY:
